<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PS1 Web Emulator - Solução Definitiva</title>
    <!-- Tailwind CSS e Fontes -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        canvas:focus { outline: none; }
        .toast {
            visibility: hidden; min-width: 250px; background-color: #333; color: #fff;
            text-align: center; border-radius: 8px; padding: 16px; position: fixed;
            z-index: 1; left: 50%; transform: translateX(-50%); bottom: 30px;
            opacity: 0; transition: opacity 0.5s, visibility 0.5s;
        }
        .toast.show { visibility: visible; opacity: 1; }
        canvas:fullscreen {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex flex-col items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-4xl mx-auto">
        <header class="text-center mb-6">
            <!-- MUDANÇA VISUAL FINALÍSSIMA: Título e cor alterados -->
            <h1 class="text-4xl font-bold text-pink-500">EMULADOR PS1 - SOLUÇÃO DEFINITIVA</h1>
            <p class="text-gray-400 mt-2">Se vir este texto, a cache foi limpa. Carregue um ficheiro .cue.</p>
        </header>

        <main class="bg-gray-800 rounded-lg shadow-2xl p-4">
            <div id="emulator-screen" class="aspect-video bg-black rounded-md overflow-hidden relative">
                <canvas id="game-canvas" class="w-full h-full"></canvas>
                <div id="initial-message" class="absolute inset-0 flex flex-col items-center justify-center text-center p-4">
                     <svg class="w-16 h-16 text-gray-500 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 7.5V6.108c0-1.135.845-2.098 1.976-2.192.353-.026.692-.026 1.038 0 .346.026.685.026 1.038 0 1.13.094 1.976 1.057 1.976 2.192V7.5M8.25 7.5h7.5m-7.5 0-1.103 9.372c-.066.564.022 1.141.222 1.683.3.812.983 1.45 1.883 1.637C10.23 20.43 10.57 20.5 11 20.5h2c.43 0 .77-.07 1.11-.208.9-.187 1.583-.825 1.883-1.637.2-.542.288-1.12.222-1.683L15.75 7.5m-7.5 0-1.409-1.409a1.125 1.125 0 0 1 0-1.591l.296-.296a1.125 1.125 0 0 1 1.591 0L8.25 7.5m7.5 0 1.409-1.409a1.125 1.125 0 0 0 0-1.591l-.296-.296a1.125 1.125 0 0 0-1.591 0L15.75 7.5" />
                    </svg>
                    <h2 class="text-2xl font-semibold">Aguardando Emulador...</h2>
                    <p class="text-gray-400 mt-2">O motor do jogo está a ser preparado.</p>
                </div>
            </div>

            <div class="mt-4 grid grid-cols-2 sm:grid-cols-4 gap-4">
                 <button id="load-rom-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 flex items-center justify-center disabled:opacity-50" disabled>
                    <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M9.25 13.25a.75.75 0 0 0 1.5 0V4.636l2.955 3.129a.75.75 0 0 0 1.09-1.03l-4.25-4.5a.75.75 0 0 0-1.09 0l-4.25 4.5a.75.75 0 1 0 1.09 1.03L9.25 4.636v8.614Z" /><path d="M3.5 12.75a.75.75 0 0 0-1.5 0v2.5A2.75 2.75 0 0 0 4.75 18h10.5A2.75 2.75 0 0 0 18 15.25v-2.5a.75.75 0 0 0-1.5 0v2.5c0 .69-.56 1.25-1.25 1.25H4.75c-.69 0-1.25-.56-1.25-1.25v-2.5Z" /></svg>
                    Carregar Jogo (.cue)
                </button>
                <button id="save-state-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 flex items-center justify-center disabled:opacity-50" disabled>
                    <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M3 3.5A1.5 1.5 0 0 1 4.5 2h6.879a1.5 1.5 0 0 1 1.06.44l4.122 4.12A1.5 1.5 0 0 1 17 7.622V16.5A1.5 1.5 0 0 1 15.5 18H4.5A1.5 1.5 0 0 1 3 16.5v-13Z" /><path d="M5 6.5A1.5 1.5 0 0 1 6.5 5h3A1.5 1.5 0 0 1 11 6.5v3A1.5 1.5 0 0 1 9.5 11h-3A1.5 1.5 0 0 1 5 9.5v-3Z" /></svg>
                    Salvar Estado
                </button>
                <button id="load-state-btn" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 flex items-center justify-center disabled:opacity-50" disabled>
                    <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M10 2a.75.75 0 0 1 .75.75v3.443l2.53-2.53a.75.75 0 0 1 1.06 1.06l-3.59 3.59a.75.75 0 0 1-1.06 0L6.16 4.72a.75.75 0 0 1 1.06-1.06l2.53 2.53V2.75A.75.75 0 0 1 10 2Z" /><path d="M3.5 9.75a.75.75 0 0 1 .75-.75h11.5a.75.75 0 0 1 0 1.5H4.25a.75.75 0 0 1-.75-.75Zm0 4a.75.75 0 0 1 .75-.75h11.5a.75.75 0 0 1 0 1.5H4.25a.75.75 0 0 1-.75-.75Z" /></svg>
                    Carregar Estado
                </button>
                <button id="fullscreen-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 flex items-center justify-center disabled:opacity-50" disabled>
                    <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M3 8.75A1.75 1.75 0 0 1 4.75 7h2.5a.75.75 0 0 1 0 1.5h-2.5A.25.25 0 0 0 4.5 9v2.5a.75.75 0 0 1-1.5 0V8.75ZM11.25 7a.75.75 0 0 1 .75.75v2.5a.75.75 0 0 1-1.5 0V9A.25.25 0 0 0 10.25 8.5h-2.5a.75.75 0 0 1 0-1.5h2.5A1.75 1.75 0 0 1 11.25 7ZM8.75 13a.75.75 0 0 1 .75.75v2.5A.25.25 0 0 0 9.75 16h2.5a.75.75 0 0 1 0 1.5h-2.5A1.75 1.75 0 0 1 8 15.25V13a.75.75 0 0 1 .75-.75ZM13 11.25a.75.75 0 0 1 .75.75v2.5A1.75 1.75 0 0 1 12.25 16h-2.5a.75.75 0 0 1 0-1.5h2.5a.25.25 0 0 0 .25-.25V12a.75.75 0 0 1 .75-.75Z" /></svg>
                    Ecrã Inteiro
                </button>
            </div>
            <input type="file" id="rom-input" hidden accept=".cue,.iso,.bin,.chd,.img">
        </main>
    </div>
    <div id="toast" class="toast">Mensagem</div>

    <!-- SOLUÇÃO ALTERNATIVA: Scripts no final do body, sem 'defer', para forçar a execução sequencial -->
    <script src="./tonic.min.js"></script>
    <script>
        // O script anterior (tonic.min.js) já foi executado e criou o objeto `wasm_bindgen`.
        // Agora, este script é executado.

        // Função principal que orquestra o arranque.
        async function main() {
            try {
                // Verificamos se a função `wasm_bindgen` realmente existe antes de a chamar.
                if (typeof wasm_bindgen !== 'function') {
                    throw new Error("A função de inicialização do emulador (wasm_bindgen) não foi encontrada.");
                }

                // Chamamos a função para carregar e compilar o ficheiro .wasm.
                // Isto modifica o objeto `wasm_bindgen` para incluir as exportações do emulador, como a classe `Emulator`.
                await wasm_bindgen('./tonic_bg.wasm');
                
                console.log("Emulador carregado e pronto!");
                initializeApp();

            } catch (error) {
                console.error("Erro fatal ao carregar o módulo WebAssembly:", error);
                const initialMessage = document.getElementById('initial-message');
                initialMessage.innerHTML = `<h2 class="text-xl text-red-400">Erro Fatal!</h2><p class="text-gray-400">Não foi possível carregar o motor do emulador.</p>`;
            }
        }

        function initializeApp() {
            const canvas = document.getElementById('game-canvas');
            const initialMessage = document.getElementById('initial-message');
            const romInput = document.getElementById('rom-input');
            const loadRomBtn = document.getElementById('load-rom-btn');
            const saveStateBtn = document.getElementById('save-state-btn');
            const loadStateBtn = document.getElementById('load-state-btn');
            const fullscreenBtn = document.getElementById('fullscreen-btn');
            let emu = null;
            let isGameLoaded = false;
            
            const allButtons = [loadRomBtn, saveStateBtn, loadStateBtn, fullscreenBtn];
            allButtons.forEach(btn => {
                btn.disabled = false;
                btn.classList.remove('disabled:opacity-50');
            });
            
            initialMessage.innerHTML = `
                <svg class="w-16 h-16 text-gray-500 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 7.5V6.108c0-1.135.845-2.098 1.976-2.192.353-.026.692-.026 1.038 0 .346.026.685.026 1.038 0 1.13.094 1.976 1.057 1.976 2.192V7.5M8.25 7.5h7.5m-7.5 0-1.103 9.372c-.066.564.022 1.141.222 1.683.3.812.983 1.45 1.883 1.637C10.23 20.43 10.57 20.5 11 20.5h2c.43 0 .77-.07 1.11-.208.9-.187 1.583-.825 1.883-1.637.2-.542.288-1.12.222-1.683L15.75 7.5m-7.5 0-1.409-1.409a1.125 1.125 0 0 1 0-1.591l.296-.296a1.125 1.125 0 0 1 1.591 0L8.25 7.5m7.5 0 1.409-1.409a1.125 1.125 0 0 0 0-1.591l-.296-.296a1.125 1.125 0 0 0-1.591 0L15.75 7.5" />
                </svg>
                <h2 class="text-2xl font-semibold">Pronto para Jogar!</h2>
                <p class="text-gray-400 mt-2">Dica: Para jogos com música, carregue o ficheiro <strong class="text-yellow-400">.CUE</strong>.</p>
            `;
    
            loadRomBtn.addEventListener('click', () => { romInput.click(); });
    
            romInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;
    
                showToast("A carregar jogo... Isto pode demorar um momento.");
                initialMessage.innerHTML = `<h2 class="text-xl">A carregar ${file.name}...</h2><p class="text-gray-400">Por favor, aguarde.</p>`;
                
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const romData = new Uint8Array(e.target.result);
                    if (emu) { await emu.exit(); }
                    
                    // Agora, o objeto `wasm_bindgen` está garantidamente pronto e com a classe `Emulator` disponível.
                    emu = new wasm_bindgen.Emulator(canvas);
    
                    try {
                        await emu.load_rom(romData);
                        initialMessage.style.display = 'none';
                        isGameLoaded = true;
                        emu.run();
                    } catch (error) {
                        console.error("Erro ao carregar a ROM:", error);
                        showToast("Falha ao carregar o ficheiro do jogo.");
                        initialMessage.style.display = 'flex';
                        initialMessage.innerHTML = `<h2 class="text-xl text-red-400">Erro!</h2><p class="text-gray-400">Não foi possível carregar este ficheiro.</p>`;
                        isGameLoaded = false;
                    }
                };
                reader.readAsArrayBuffer(file);
            });
    
            saveStateBtn.addEventListener('click', async () => {
                if (!isGameLoaded || !emu) { showToast("Nenhum jogo em execução para guardar."); return; }
                try {
                    const state = await emu.save_state();
                    await saveStateToDB(state);
                } catch (error) {
                    console.error("Erro ao guardar estado:", error);
                    showToast("Falha ao guardar o estado.");
                }
            });
    
            loadStateBtn.addEventListener('click', async () => {
                if (!isGameLoaded || !emu) { showToast("Nenhum jogo em execução para carregar estado."); return; }
                try {
                    const stateData = await loadStateFromDB();
                    if (stateData) {
                        await emu.load_state(stateData);
                        showToast("Estado carregado com sucesso!");
                    } else {
                        showToast("Nenhum estado guardado encontrado.");
                    }
                } catch (error) {
                    console.error("Erro ao carregar estado:", error);
                    showToast("Falha ao carregar o estado.");
                }
            });
    
            fullscreenBtn.addEventListener('click', () => {
                if (!document.fullscreenElement) {
                    canvas.requestFullscreen().catch(err => {
                        showToast(`Erro ecrã inteiro: ${err.message}`);
                    });
                } else {
                    document.exitFullscreen();
                }
            });
        }
        
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => { toast.classList.remove('show'); }, 3000);
        }

        const DB_NAME = 'PS1_EMU_SAVES';
        const STORE_NAME = 'save_states';
        let db;

        const request = indexedDB.open(DB_NAME, 1);
        request.onerror = (event) => console.error("Erro no IndexedDB:", event);
        request.onsuccess = (event) => db = event.target.result;
        request.onupgradeneeded = (event) => {
            db = event.target.result;
            db.createObjectStore(STORE_NAME);
        };

        async function saveStateToDB(stateData) {
            if (!db) { showToast("Erro: Base de dados não está pronta."); return; }
            const transaction = db.transaction(STORE_NAME, 'readwrite');
            const store = transaction.objectStore(STORE_NAME);
            store.put(stateData, 'slot_1');
            return new Promise((resolve) => {
                transaction.oncomplete = () => {
                    showToast("Estado guardado com sucesso!");
                    resolve();
                };
            });
        }

        async function loadStateFromDB() {
            if (!db) { showToast("Erro: Base de dados não está pronta."); return null; }
            const transaction = db.transaction(STORE_NAME, 'readonly');
            const store = transaction.objectStore(STORE_NAME);
            const request = store.get('slot_1');
            return new Promise((resolve, reject) => {
                request.onsuccess = () => resolve(request.result);
                request.onerror = (event) => reject(event);
            });
        }
        
        // Inicia todo o processo assim que o DOM estiver pronto.
        document.addEventListener('DOMContentLoaded', main);
    </script>
</body>
</html>

