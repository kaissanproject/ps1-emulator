<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PS1 Web Emulator</title>
    <!-- Tailwind CSS para estilização rápida e responsiva -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Fonte Inter do Google Fonts para uma aparência moderna -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Estilo para a tela do emulador quando focada */
        canvas:focus {
            outline: none;
        }
        /* Estilo para notificações flutuantes */
        .toast {
            visibility: hidden;
            min-width: 250px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 8px;
            padding: 16px;
            position: fixed;
            z-index: 1;
            left: 50%;
            transform: translateX(-50%);
            bottom: 30px;
            opacity: 0;
            transition: opacity 0.5s, visibility 0.5s;
        }
        .toast.show {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex flex-col items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-4xl mx-auto">
        <header class="text-center mb-6">
            <h1 class="text-4xl font-bold text-blue-400">PS1 Web Emulator</h1>
            <p class="text-gray-400 mt-2">Jogue os seus clássicos de PlayStation 1 diretamente no navegador.</p>
        </header>

        <main class="bg-gray-800 rounded-lg shadow-2xl p-4">
            <!-- Tela do Emulador -->
            <div id="emulator-screen" class="aspect-video bg-black rounded-md overflow-hidden relative">
                <canvas id="game-canvas" class="w-full h-full"></canvas>
                <!-- Mensagem inicial para o utilizador -->
                <div id="initial-message" class="absolute inset-0 flex flex-col items-center justify-center text-center p-4">
                    <svg class="w-16 h-16 text-gray-500 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 7.5V6.108c0-1.135.845-2.098 1.976-2.192.353-.026.692-.026 1.038 0 .346.026.685.026 1.038 0 1.13.094 1.976 1.057 1.976 2.192V7.5M8.25 7.5h7.5m-7.5 0-1.103 9.372c-.066.564.022 1.141.222 1.683.3.812.983 1.45 1.883 1.637C10.23 20.43 10.57 20.5 11 20.5h2c.43 0 .77-.07 1.11-.208.9-.187 1.583-.825 1.883-1.637.2-.542.288-1.12.222-1.683L15.75 7.5m-7.5 0-1.409-1.409a1.125 1.125 0 0 1 0-1.591l.296-.296a1.125 1.125 0 0 1 1.591 0L8.25 7.5m7.5 0 1.409-1.409a1.125 1.125 0 0 0 0-1.591l-.296-.296a1.125 1.125 0 0 0-1.591 0L15.75 7.5" />
                    </svg>
                    <h2 class="text-2xl font-semibold">Nenhum jogo carregado</h2>
                    <p class="text-gray-400 mt-2">Clique em "Carregar Jogo" para selecionar um ficheiro ISO/BIN/CUE do seu computador.</p>
                </div>
            </div>

            <!-- Painel de Controlo -->
            <div class="mt-4 grid grid-cols-2 sm:grid-cols-4 gap-4">
                <button id="load-rom-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 flex items-center justify-center">
                    <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M9.25 13.25a.75.75 0 0 0 1.5 0V4.636l2.955 3.129a.75.75 0 0 0 1.09-1.03l-4.25-4.5a.75.75 0 0 0-1.09 0l-4.25 4.5a.75.75 0 1 0 1.09 1.03L9.25 4.636v8.614Z" /><path d="M3.5 12.75a.75.75 0 0 0-1.5 0v2.5A2.75 2.75 0 0 0 4.75 18h10.5A2.75 2.75 0 0 0 18 15.25v-2.5a.75.75 0 0 0-1.5 0v2.5c0 .69-.56 1.25-1.25 1.25H4.75c-.69 0-1.25-.56-1.25-1.25v-2.5Z" /></svg>
                    Carregar Jogo
                </button>
                <button id="save-state-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 flex items-center justify-center">
                    <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M3 3.5A1.5 1.5 0 0 1 4.5 2h6.879a1.5 1.5 0 0 1 1.06.44l4.122 4.12A1.5 1.5 0 0 1 17 7.622V16.5A1.5 1.5 0 0 1 15.5 18H4.5A1.5 1.5 0 0 1 3 16.5v-13Z" /><path d="M5 6.5A1.5 1.5 0 0 1 6.5 5h3A1.5 1.5 0 0 1 11 6.5v3A1.5 1.5 0 0 1 9.5 11h-3A1.5 1.5 0 0 1 5 9.5v-3Z" /><path d="M12.5 11.5A1.5 1.5 0 0 1 14 10h1.5a.5.5 0 0 0 0-1H14a1.5 1.5 0 0 1-1.5-1.5V6.5a.5.5 0 0 0-1 0v1A1.5 1.5 0 0 1 10 9v1.5a.5.5 0 0 0 1 0V9a1.5 1.5 0 0 1 1.5-1.5h1a.5.5 0 0 0 0 1h-1A1.5 1.5 0 0 1 11 10v1.5a.5.5 0 0 0 1 0v-1A1.5 1.5 0 0 1 13.5 9h.091a1.5 1.5 0 0 1 1.06.44l.001.001.001.001a.5.5 0 0 0 .707-.707l-.002-.002a2.5 2.5 0 0 0-1.766-.734H13.5A2.5 2.5 0 0 0 11 10v1.5a1.5 1.5 0 0 1-1.5 1.5h-3A1.5 1.5 0 0 1 5 11.5v-3A1.5 1.5 0 0 1 6.5 7h3A1.5 1.5 0 0 1 11 8.5V10a.5.5 0 0 0 1 0V8.5A2.5 2.5 0 0 0 9.5 6h-3A2.5 2.5 0 0 0 4 8.5v3A2.5 2.5 0 0 0 6.5 14h3a.5.5 0 0 0 0-1h-3A1.5 1.5 0 0 1 5.5 12h5a.5.5 0 0 0 0-1h-5A1.5 1.5 0 0 1 4 9.5V8.5a.5.5 0 0 0-1 0v1A2.5 2.5 0 0 0 5.5 12h5A1.5 1.5 0 0 1 12 10.5V10a.5.5 0 0 0-1 0v.5a.5.5 0 0 0 .5.5h.5a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-1 0v1A1.5 1.5 0 0 1 10.5 13h-4A2.5 2.5 0 0 0 4 15.5V16a.5.5 0 0 0 1 0v-.5a1.5 1.5 0 0 1 1.5-1.5h7A1.5 1.5 0 0 1 15 15.5V16a.5.5 0 0 0 1 0v-.5a2.5 2.5 0 0 0-2.5-2.5h-7a.5.5 0 0 0-.5.5v.5a.5.5 0 0 0 1 0v-.5A1.5 1.5 0 0 1 8.5 12h2a.5.5 0 0 0 0-1h-2A2.5 2.5 0 0 0 6.5 13H5.5a.5.5 0 0 0-.5.5v.5a.5.5 0 0 0 1 0v-.5A1.5 1.5 0 0 1 7.5 12H9a.5.5 0 0 0 0-1H7.5A2.5 2.5 0 0 0 5 13.5v.001a.5.5 0 0 0 0 .998V14a.5.5 0 0 0 .5.5h.5a.5.5 0 0 0 0-1h-.5a.5.5 0 0 0-.5-.5v-1a.5.5 0 0 0-.998 0H4.5a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 1 0v-1a.5.5 0 0 0-.5-.5h-1a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 1 0v-1a.5.5 0 0 0-.5-.5Z" /></svg>
                    Salvar Estado
                </button>
                <button id="load-state-btn" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 flex items-center justify-center">
                    <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M10 2a.75.75 0 0 1 .75.75v3.443l2.53-2.53a.75.75 0 0 1 1.06 1.06l-3.59 3.59a.75.75 0 0 1-1.06 0L6.16 4.72a.75.75 0 0 1 1.06-1.06l2.53 2.53V2.75A.75.75 0 0 1 10 2Z" /><path d="M3.5 9.75a.75.75 0 0 1 .75-.75h11.5a.75.75 0 0 1 0 1.5H4.25a.75.75 0 0 1-.75-.75Zm0 4a.75.75 0 0 1 .75-.75h11.5a.75.75 0 0 1 0 1.5H4.25a.75.75 0 0 1-.75-.75Z" /></svg>
                    Carregar Estado
                </button>
                <button id="fullscreen-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 flex items-center justify-center">
                    <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M3 8.75A1.75 1.75 0 0 1 4.75 7h2.5a.75.75 0 0 1 0 1.5h-2.5A.25.25 0 0 0 4.5 9v2.5a.75.75 0 0 1-1.5 0V8.75ZM11.25 7a.75.75 0 0 1 .75.75v2.5a.75.75 0 0 1-1.5 0V9A.25.25 0 0 0 10.25 8.5h-2.5a.75.75 0 0 1 0-1.5h2.5A1.75 1.75 0 0 1 11.25 7ZM8.75 13a.75.75 0 0 1 .75.75v2.5A.25.25 0 0 0 9.75 16h2.5a.75.75 0 0 1 0 1.5h-2.5A1.75 1.75 0 0 1 8 15.25V13a.75.75 0 0 1 .75-.75ZM13 11.25a.75.75 0 0 1 .75.75v2.5A1.75 1.75 0 0 1 12.25 16h-2.5a.75.75 0 0 1 0-1.5h2.5a.25.25 0 0 0 .25-.25V12a.75.75 0 0 1 .75-.75Z" /></svg>
                    Ecrã Inteiro
                </button>
            </div>
            <!-- Input de ficheiro oculto, acionado pelo botão -->
            <input type="file" id="rom-input" hidden accept=".iso,.bin,.cue,.img,.chd">
        </main>
    </div>

    <!-- Elemento para notificações (toast) -->
    <div id="toast" class="toast">Mensagem</div>

    <!-- Carregamento do emulador via módulo ES.
         [CORREÇÃO FINAL]: Link do jsDelivr corrigido, que permite partilha entre sites (CORS). -->
    <script type="module">
        import * as Tonic from 'https://cdn.jsdelivr.net/npm/tonic-psx-wasm@0.4.1/dist/tonic.min.js';

        // --- Referências aos elementos do DOM ---
        const canvas = document.getElementById('game-canvas');
        const initialMessage = document.getElementById('initial-message');
        const romInput = document.getElementById('rom-input');
        const loadRomBtn = document.getElementById('load-rom-btn');
        const saveStateBtn = document.getElementById('save-state-btn');
        const loadStateBtn = document.getElementById('load-state-btn');
        const fullscreenBtn = document.getElementById('fullscreen-btn');
        const toast = document.getElementById('toast');

        let emu = null; // Variável para a instância do emulador
        let isGameLoaded = false;

        // --- Lógica para Notificações (Toast) ---
        function showToast(message) {
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000); // A notificação desaparece após 3 segundos
        }

        // --- Lógica de Banco de Dados Local (IndexedDB) para Guardar Estados ---
        const DB_NAME = 'PS1_EMU_SAVES';
        const STORE_NAME = 'save_states';
        let db;

        // Abre ou cria o banco de dados
        const request = indexedDB.open(DB_NAME, 1);
        request.onerror = (event) => console.error("Erro no IndexedDB:", event);
        request.onsuccess = (event) => db = event.target.result;
        request.onupgradeneeded = (event) => {
            const db = event.target.result;
            db.createObjectStore(STORE_NAME);
        };

        // Função para guardar o estado no IndexedDB
        async function saveStateToDB(stateData) {
            if (!db) {
                showToast("Erro: Base de dados não está pronta.");
                return;
            }
            const transaction = db.transaction(STORE_NAME, 'readwrite');
            const store = transaction.objectStore(STORE_NAME);
            store.put(stateData, 'slot_1'); // Usamos uma chave fixa "slot_1"
            return new Promise((resolve) => {
                transaction.oncomplete = () => {
                    showToast("Estado guardado com sucesso!");
                    resolve();
                };
            });
        }

        // Função para carregar o estado do IndexedDB
        async function loadStateFromDB() {
            if (!db) {
                showToast("Erro: Base de dados não está pronta.");
                return null;
            }
            const transaction = db.transaction(STORE_NAME, 'readonly');
            const store = transaction.objectStore(STORE_NAME);
            const request = store.get('slot_1');
            return new Promise((resolve, reject) => {
                request.onsuccess = () => resolve(request.result);
                request.onerror = (event) => reject(event);
            });
        }

        // --- Inicialização e Eventos dos Botões ---

        // Botão Carregar Jogo
        loadRomBtn.addEventListener('click', () => {
            romInput.click(); // Abre a janela de seleção de ficheiro
        });

        // Quando um ficheiro é selecionado
        romInput.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) return;

            showToast("A carregar jogo... Isto pode demorar um momento.");
            initialMessage.innerHTML = `<h2 class="text-xl">A carregar ${file.name}...</h2><p class="text-gray-400">Por favor, aguarde.</p>`;

            const reader = new FileReader();
            reader.onload = async (e) => {
                const romData = e.target.result; // O conteúdo do ficheiro como ArrayBuffer

                // Se o emulador já existe, reinicia antes de carregar nova ROM
                if (emu) {
                    await emu.exit();
                }
                
                // Instancia o emulador com o canvas
                emu = new Tonic.Emulator(canvas);

                try {
                    await emu.load_rom(romData);
                    initialMessage.style.display = 'none'; // Esconde a mensagem inicial
                    isGameLoaded = true;
                    emu.run(); // Inicia a emulação
                } catch (error) {
                    console.error("Erro ao carregar a ROM:", error);
                    showToast("Falha ao carregar o ficheiro do jogo.");
                    initialMessage.style.display = 'flex';
                    initialMessage.innerHTML = `<h2 class="text-xl text-red-400">Erro!</h2><p class="text-gray-400">Não foi possível carregar este ficheiro. Verifique se é um formato de jogo PS1 válido (.iso, .bin, .cue).</p>`;
                    isGameLoaded = false;
                }
            };
            reader.readAsArrayBuffer(file);
        });

        // Botão Salvar Estado
        saveStateBtn.addEventListener('click', async () => {
            if (!isGameLoaded || !emu) {
                showToast("Nenhum jogo em execução para guardar.");
                return;
            }
            try {
                const state = await emu.save_state();
                await saveStateToDB(state);
            } catch (error) {
                console.error("Erro ao guardar estado:", error);
                showToast("Falha ao guardar o estado.");
            }
        });

        // Botão Carregar Estado
        loadStateBtn.addEventListener('click', async () => {
            if (!isGameLoaded || !emu) {
                showToast("Nenhum jogo em execução para carregar estado.");
                return;
            }
            try {
                const stateData = await loadStateFromDB();
                if (stateData) {
                    await emu.load_state(stateData);
                    showToast("Estado carregado com sucesso!");
                } else {
                    showToast("Nenhum estado guardado encontrado.");
                }
            } catch (error) {
                console.error("Erro ao carregar estado:", error);
                showToast("Falha ao carregar o estado.");
            }
        });

        // Botão Ecrã Inteiro
        fullscreenBtn.addEventListener('click', () => {
            if (!document.fullscreenElement) {
                canvas.requestFullscreen().catch(err => {
                    alert(`Erro ao tentar entrar em ecrã inteiro: ${err.message}`);
                });
            } else {
                document.exitFullscreen();
            }
        });
    </script>
</body>
</html>

